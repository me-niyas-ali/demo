<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>Library App - User & Admin</title>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<style>
@keyframes slideInRight {
 from {
  transform: translateX(100%);
  opacity: 0;
 }
 to {
  transform: translateX(0);
  opacity: 1;
 }
}

@keyframes slideOutRight {
 from {
  transform: translateX(0);
  opacity: 1;
 }
 to {
  transform: translateX(100%);
  opacity: 0;
 }
}

 .toast.slide-in {
  animation: slideInRight 0.4s ease forwards;
 }

 .toast.slide-out {
  animation: slideOutRight 0.4s ease forwards;
 }

 .book-title-wrapper {
  position: relative;
  overflow: hidden;
  white-space: nowrap;
  width: 100%;
 }

 .book-title {
  display: inline-block;
  white-space: nowrap;
  will-change: transform;
  animation: scroll-title 10s linear infinite;
  animation-play-state: paused;
 }
 
 .italic {
  font-style: italic;
 }

@keyframes scroll-title {
  0% {
   transform: translateX(0%);
  }
  30% {
   transform: translateX(0%);
  }
  100% {
   transform: translateX(-100%);
  }
 }

</style>

<body>
 <div class="container py-4">

  <!-- Main action Buttons -->

  <div class="card mb-2 position-absolute top-50 start-50 translate-middle" style="width:80vw;max-width:550px" id="main-action-btn">
   <div class="card-header">
    <center><h2 class="mb-0 p-2">1133 PKNS LIBRARY</h2></center>
   </div>
   <div class="card-body">
    <div class="d-grid gap-4">
     <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#signupModal">User Sign Up</button>
     <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#loginModal">User Login</button>
     <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#adminLoginModal">Admin Login</button>
    </div>
   </div>
  </div>

  <!-- User logged in message -->

  <div id="userSection" class="d-none">

   <!-- Welcome Card -->

   <div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center p-3" style="background-color:#e6e6e6">
     <h4 class="m-0">Welcome, <span id="userFullname"></span></h4>
     <button id="userLogoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
   </div>

   <!-- Available Books Card -->

   <div class="card mb-3">
    <div class="card-header">
     <h5 class="mb-0">Available Books</h5>
    </div>
    <div class="px-2 mt-2">
     <input type="text" autocomplete="off" id="userBookSearch" class="form-control form-control" placeholder="Search by title or author...">
    </div>
    <div class="card-body p-2">
     <div id="booksCardContainer" class="d-flex overflow-auto gap-2"></div>
    </div>
   </div>

   <!-- User History Card -->

   <div class="card mb-3">
    <div class="card-header">
     <h5 class="mb-0">Your Book Requests & Checkouts</h5>
    </div>
    <div class="px-2 mt-2">
     <input type="text" autocomplete="off" id="searchUserHistory" class="form-control form-control" placeholder="Search by book title...">
    </div>

    <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
     <table class="table table-sm mb-0" id="userHistoryTable">
      <thead>
       <tr>
        <th>Title</th>
        <th>Status</th>
        <th>Requested At</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>
  </div>

  <!-- Admin dashboard -->

  <div id="adminSection" class="d-none">

   <!-- Welcome Card -->
   <div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center p-3" style="background-color:#e6e6e6">
     <h4 class="m-0">Admin Dashboard</h4>
     <button id="adminLogoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
   </div>

   <div class="container-fluid p-0">
    <div class="row g-3 mb-3">

     <!-- Pending Signup Requests -->
     <div class="col-12 col-lg-6" id="psr">
      <div class="card h-100">
       <div class="card-header">
        <h5 class="mb-0">Pending Signup Requests</h5>
       </div>
       <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
        <table class="table table-sm mb-0" id="signupRequestsTable">
         <thead>
          <tr>
           <th>Full Name</th>
           <th>Email</th>
           <th>DOB</th>
           <th>Blood Group</th>
           <th>Actions</th>
          </tr>
         </thead>
         <tbody></tbody>
        </table>
       </div>
      </div>
     </div>

     <!-- Pending Book Requests -->
     <div class="col-12 col-lg-6" id="pbr">
      <div class="card h-100">
       <div class="card-header">
        <h5 class="mb-0">Pending Book Requests</h5>
       </div>
       <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
        <table class="table table-sm mb-0" id="bookRequestsTable">
         <thead>
          <tr>
           <th>User</th>
           <th>Title</th>
           <th>Author</th>
           <th>Status</th>
           <th>Actions</th>
          </tr>
         </thead>
         <tbody></tbody>
        </table>
       </div>
      </div>
     </div>

     <!-- All Books -->

     <div class="col-12">
      <div class="card">
       <div class="card-header">
        <h5 class="mb-0">All Books</h5>
       </div>
       <div class="px-2 mt-2">
        <input type="text" autocomplete="off" id="adminBookSearch" class="form-control form-control" placeholder="Search by title or author...">
       </div>
       <div class="card-body p-2">
        <div id="allBooksCardContainer" class="d-flex overflow-auto gap-2 flex-nowrap"></div>
       </div>
      </div>
     </div>

     <!-- Active Checked Out Books -->
     <div class="col-12">
      <div class="card h-100">
       <div class="card-header">
        <h5 class="mb-0">Active Checked Out Books</h5>
       </div>
       <div class="px-2 mt-2">
        <input type="text" autocomplete="off" id="searchCheckedOutBooks" class="form-control form-control" placeholder="Search by User Name or Book Title...">
       </div>
       <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
        <table class="table table-sm mb-0" id="checkedOutBooksTable">
         <thead>
          <tr>
           <th>User</th>
           <th>Title</th>
           <th>Author</th>
           <th>Checked Out At</th>
           <th>Actions</th>
          </tr>
         </thead>
         <tbody></tbody>
        </table>
       </div>
      </div>
     </div>

    </div>
   </div>


   <!-- Add New Book -->
<div class="card mb-3">
 <div class="card-header">
  <h5 class="mb-0">Add New Book</h5>
 </div>
 <div class="card-body">
  <form id="addBookForm" class="row g-2">
   <div class="col-md-3">
    <input type="text" id="bookTitle" autocomplete="off" class="form-control" placeholder="Title" required />
   </div>
   <div class="col-md-3">
    <input type="text" id="bookAuthor" autocomplete="off" class="form-control" placeholder="Author" required />
   </div>
   <div class="col-md-3">
    <input type="url" id="bookCoverUrl" autocomplete="off" class="form-control" placeholder="Cover Image URL (GitHub)" />
   </div>
   <div class="col-md-3">
    <input type="text" id="bookSponsor" autocomplete="off" class="form-control" placeholder="Sponsored By" />
   </div>
   <div class="col-md-2">
    <select id="bookAvailability" class="form-select" required>
     <option value="Available" selected>Available</option>
     <option value="Checked Out">Checked Out</option>
    </select>
   </div>
   <div class="col-md-2">
    <button type="submit" class="btn btn-success w-100">Add Book</button>
   </div>
  </form>
 </div>
</div>


   <!-- All Users -->

   <div class="card mb-3">
    <div class="card-header">
     <h5 class="mb-0">All Users</h5>
    </div>
    <div class="px-2 mt-2">
     <input type="text" autocomplete="off" id="searchAllUsers" class="form-control form-control" placeholder="Search by User Name...">
    </div>
    <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
     <table class="table table-sm mb-0" id="allUsersTable">
      <thead>
       <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>DOB</th>
        <th>Blood Group</th>
        <th>Joined At</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>

   <!-- All Book Requests History -->

   <div class="card mb-3">
    <div class="card-header">
     <h5 class="mb-0">All Book Requests History</h5>
    </div>
    <div class="px-2 mt-2">
     <input type="text" autocomplete="off" id="searchAllBookRequests" class="form-control form-control" placeholder="Search by user name or book title...">
    </div>
    <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
     <table class="table table-sm mb-0" id="allBookRequestsTable">
      <thead>
       <tr>
        <th>User</th>
        <th>Book Title</th>
        <th>Status</th>
        <th>Requested At</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>

   <!-- Rejected Book Requests -->

   <div class="card mb-3">
    <div class="card-header">
     <h5 class="mb-0">Rejected Book Requests</h5>
    </div>
    <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
     <table class="table table-sm mb-0" id="rejectedRequestsTable">
      <thead>
       <tr>
        <th>User</th>
        <th>Book Title</th>
        <th>Current Status</th>
        <th>Rejected At</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
   </div>
  </div>
 </div>

 <!-- Signup Modal -->

 <div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
   <form id="signupForm" class="modal-content needs-validation" novalidate>
    <div class="modal-header">
     <h5 class="modal-title">User Signup</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
     <div class="mb-3">
      <label for="fullname" class="form-label">Full Name</label>
      <input type="text" id="fullname" autocomplete="off" class="form-control" required />
      <div class="invalid-feedback">
       Please enter your full name.
      </div>
     </div>
     <div class="mb-3">
      <label for="email" class="form-label">Email address</label>
      <input type="email" id="email" autocomplete="off" class="form-control" required />
      <div class="invalid-feedback">
       Please enter a valid email.
      </div>
     </div>
     <div class="mb-3">
      <label for="dob" class="form-label">Date of Birth</label>
      <input type="date" id="dob" autocomplete="off" class="form-control" required />
      <div class="invalid-feedback">
       Please enter your date of birth.
      </div>
     </div>
     <div class="mb-3">
      <label for="bloodGroup" class="form-label">Blood Group</label>
      <input type="text" id="bloodGroup" autocomplete="off" class="form-control" required />
      <div class="invalid-feedback">
       Please enter your blood group.
      </div>
     </div>
     <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" id="password" autocomplete="off" class="form-control" required minlength="6" />
      <div class="invalid-feedback">
       Please enter a password (min 6 characters).
      </div>
     </div>
    </div>
    <div class="modal-footer">
     <button type="submit" class="btn btn-primary">Sign Up</button>
    </div>
   </form>
  </div>
 </div>

 <!-- User Login Modal -->

 <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
   <form id="loginForm" class="modal-content needs-validation" novalidate>
    <div class="modal-header">
     <h5 class="modal-title">User Login</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
     <div class="mb-3">
      <label for="loginEmail" class="form-label">Email address</label>
      <input type="email" id="loginEmail" class="form-control" required />
      <div class="invalid-feedback">
       Please enter your email.
      </div>
     </div>
     <div class="mb-3">
      <label for="loginPassword" class="form-label">Password</label>
      <input type="password" id="loginPassword" class="form-control" required minlength="6" />
      <div class="invalid-feedback">
       Please enter your password.
      </div>
     </div>
    </div>
    <div class="modal-footer">
     <button type="submit" class="btn btn-primary">Login</button>
    </div>
   </form>
  </div>
 </div>

 <!-- Admin Login Modal -->

 <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
   <form id="adminLoginForm" class="modal-content needs-validation" novalidate>
    <div class="modal-header">
     <h5 class="modal-title">Admin Login</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
     <div class="mb-3">
      <label for="adminEmail" class="form-label">Email address</label>
      <input type="email" id="adminEmail" class="form-control" required />
      <div class="invalid-feedback">
       Please enter your email.
      </div>
     </div>
     <div class="mb-3">
      <label for="adminPassword" class="form-label">Password</label>
      <input type="password" id="adminPassword" class="form-control" required minlength="6" />
      <div class="invalid-feedback">
       Please enter your password.
      </div>
     </div>
    </div>
    <div class="modal-footer">
     <button type="submit" class="btn btn-danger">Login as Admin</button>
    </div>
   </form>
  </div>
 </div>

 <!-- Toast Notification-->

 <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1100;margin-bottom: -15px"></div>

 <!-- Delete Confirmation Modal -->
 <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
   <div class="modal-content">
    <div class="modal-header px-4 p-2">
     <h5 class="modal-title">Confirm Delete</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body px-3 m-0">
     <p id="deleteConfirmText">
      Are you sure you want to delete this book?
     </p>
    </div>
    <div class="modal-footer m-0">
     <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
     <button type="button" class="btn btn-sm btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
    </div>
   </div>
  </div>
 </div>

 <!-- Fullscreen Loader -->
 <div id="loadingBackdrop" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center d-none" style="z-index: 2000;">
  <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
   <span class="visually-hidden">Loading...</span>
  </div>
 </div>

 <!-- Conntent End-->
 
 <!-- Test Scripts Here-->
 <script>

 </script>
 <!-- Test Scripts Here-->
 

 <script type="module">
  import {
   initializeApp
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
   getFirestore,
   collection,
   addDoc,
   getDocs,
   doc,
   deleteDoc,
   setDoc,
   updateDoc,
   query,
   where,
   onSnapshot,
   getDoc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import {
   getAuth,
   createUserWithEmailAndPassword,
   signInWithEmailAndPassword,
   signOut,
   onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  // Your Firebase config (replace with your config)
  const firebaseConfig = {
   apiKey: "AIzaSyCzaPyBZ0t5R80ERXaCO2rVAAWGBCEILI8",
   authDomain: "libraryapp-2025.firebaseapp.com",
   databaseURL: "https://libraryapp-2025-default-rtdb.firebaseio.com",
   projectId: "libraryapp-2025",
   storageBucket: "libraryapp-2025.firebasestorage.app",
   messagingSenderId: "681370266458",
   appId: "1:681370266458:web:bd978d0567e629a13ea163",
   measurementId: "G-6M4YEF78HY"
  };
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  // Bootstrap modal helpers
  const signupModalEl = document.getElementById('signupModal');
  const loginModalEl = document.getElementById('loginModal');
  const adminLoginModalEl = document.getElementById('adminLoginModal');
  const signupModal = bootstrap.Modal.getOrCreateInstance(signupModalEl);
  const loginModal = bootstrap.Modal.getOrCreateInstance(loginModalEl);
  const adminLoginModal = bootstrap.Modal.getOrCreateInstance(adminLoginModalEl);
  const deleteConfirmModalEl = document.getElementById("deleteConfirmModal");
  const deleteConfirmModal = bootstrap.Modal.getOrCreateInstance(deleteConfirmModalEl);
  const deleteConfirmText = document.getElementById("deleteConfirmText");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

  let bookIdToDelete = null;
  let bookTitleToDelete = null;


  // Validation helper
  function enableBootstrapValidation(form) {
   form.addEventListener("submit", (event) => {
    if (!form.checkValidity()) {
     event.preventDefault();
     event.stopPropagation();
    }
    form.classList.add("was-validated");
   },
    false);
  }

  // --- SIGNUP ---

  const signupForm = document.getElementById("signupForm");
  enableBootstrapValidation(signupForm);
  signupForm.addEventListener("submit", async (e) => {
   e.preventDefault();
   if (!signupForm.checkValidity()) return;
   const fullname = document.getElementById("fullname").value.trim();
   const email = document.getElementById("email").value.trim();
   const dob = document.getElementById("dob").value;
   const bloodGroup = document.getElementById("bloodGroup").value.trim();
   const password = document.getElementById("password").value;
   try {
    showLoader();
    await addDoc(collection(db, "signupRequests"), {
     fullname,
     email,
     dob,
     bloodGroup,
     password,
     createdAt: new Date().toISOString(),
    });
    showToast("Signup request submitted. Wait for admin approval.", "bg-warning");
    hideLoader();
    signupForm.reset();
    signupForm.classList.remove("was-validated");
    signupModal.hide();
   } catch (error) {
    showToast("Error submitting signup request: " + error.message, "bg-danger");
   }
  });

  // --- USER LOGIN ---

  const loginForm = document.getElementById("loginForm");
  enableBootstrapValidation(loginForm);
  loginForm.addEventListener("submit", async (e) => {
   e.preventDefault();
   if (!loginForm.checkValidity()) return;
   const email = document.getElementById("loginEmail").value.trim();
   const password = document.getElementById("loginPassword").value;
   showLoader();
   try {
    await signInWithEmailAndPassword(auth, email, password);
    loginForm.reset();
    loginForm.classList.remove("was-validated");
    loginModal.hide();
   } catch (error) {
    showToast("Login failed: " + error.message, "bg-danger");
    hideLoader();
   }
  });

  // --- ADMIN LOGIN ---
  // Only allow login for admin users (role: "admin")

  const adminLoginForm = document.getElementById("adminLoginForm");
  enableBootstrapValidation(adminLoginForm);
  adminLoginForm.addEventListener("submit", async (e) => {
   e.preventDefault();
   if (!adminLoginForm.checkValidity()) return;
   const email = document.getElementById("adminEmail").value.trim();
   const password = document.getElementById("adminPassword").value;
   showLoader();
   try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
     await signOut(auth);
     showToast("Access denied: Not an admin.", "bg-danger");
     hideLoader();
     return;
    }
    adminLoginForm.reset();
    adminLoginForm.classList.remove("was-validated");
    adminLoginModal.hide();
   } catch (error) {
    showToast("Admin login failed: " + error.message, "bg-danger");
    hideLoader();
   }
  });

  // --- LOGOUT ---

  function handleLogout() {
   showLoader();
   setTimeout(async () => {
    try {
     await signOut(auth);
     showToast("You have been logged out.", "bg-success");
     hideLoader();
    } catch (err) {
     showToast("Logout failed: " + err.message, "bg-danger");
     hideLoader();
    }
   },
    1000);
  }

  document.getElementById("userLogoutBtn").onclick = handleLogout;
  document.getElementById("adminLogoutBtn").onclick = handleLogout;


  // --- UI Elements ---

  const userSection = document.getElementById("userSection");
  const userFullnameSpan = document.getElementById("userFullname");
  const booksTableBody = document.querySelector("#booksTable tbody");
  const adminSection = document.getElementById("adminSection");
  const signupRequestsTableBody = document.querySelector("#signupRequestsTable tbody");
  const allBooksTableBody = document.querySelector("#allBooksTable tbody");
  const allUsersTableBody = document.querySelector("#allUsersTable tbody");
  const addBookForm = document.getElementById("addBookForm");
  showLoader();
  // --- Authentication State Observer ---
  onAuthStateChanged(auth, async (user) => {
   if (user) {
    // Check role
    const userDoc = await getDoc(doc(db, "users", user.uid));
    const role = userDoc.exists() ? userDoc.data().role: null;
    if (role === "admin") {
     showAdminDashboard();
    } else if (role === "user") {
     showUserDashboard(user.uid);
    } else {
     showToast("No role assigned. Please contact admin.", "bg-warning");
     await signOut(auth);
     showLoggedOut();
    }
   } else {
    showLoggedOut();
    hideLoader();
   }
  });

  // --- Show Logged Out ---

  function showLoggedOut() {
   userSection.classList.add("d-none");
   adminSection.classList.add("d-none");
   document.getElementById("main-action-btn").classList.remove("d-none");
  }

  // --- Show User Dashboard ---

  async function showUserDashboard(uid) {
   adminSection.classList.add("d-none");
   userSection.classList.remove("d-none");
   document.getElementById("main-action-btn").classList.add("d-none");
   signupModal.hide();
   loginModal.hide();
   adminLoginModal.hide();

   try {
    const userDoc = await getDoc(doc(db, "users", uid));
    if (userDoc.exists()) {
     userFullnameSpan.textContent = userDoc.data().fullname || "";
    }
   } catch (err) {
    console.error("Error loading user info:", err);
   }

   onSnapshot(
    query(collection(db, "bookRequests"), where("status", "in", ["Pending", "Approved"])),
    async (activeSnap) => {
     const activeRequests = new Set();
     const userRequests = new Set();

     activeSnap.forEach((doc) => {
      const data = doc.data();
      activeRequests.add(data.bookId);
      if (data.userId === uid) {
       userRequests.add(data.bookId);
      }
     });

     onSnapshot(collection(db, "books"),
      (bookSnap) => {
       const booksCardContainer = document.getElementById("booksCardContainer");
       booksCardContainer.innerHTML = "";
       const books = [];
       bookSnap.forEach((docSnap) => {
        books.push({
         ...docSnap.data(), id: docSnap.id
        });
       });

       books
       .sort((a, b) => (a.title || "").localeCompare(b.title || ""))
       .forEach((book) => {
        const bookId = book.id;
        const status = book.availability || "Unavailable";

        let buttonText = "Request";
        let buttonClass = "btn-primary";
        let buttonDisabled = false;
        let isUserRequest = false;

        if (activeRequests.has(bookId)) {
         buttonText = "Not Available";
         buttonClass = "btn-secondary";
         buttonDisabled = true;
         if (userRequests.has(bookId)) {
          buttonText = "Cancel Request";
          buttonClass = "btn-danger";
          buttonDisabled = false;
          isUserRequest = true;
         }
        } else if (status !== "Available") {
         buttonText = "Not Available";
         buttonClass = "btn-secondary";
         buttonDisabled = true;
        }

        // Create card container
        const card = document.createElement("div");
        card.className = "card";
        card.style.minWidth = "180px";
        card.style.maxWidth = "180px";

        // Determine badge color
        let badgeColor = "secondary";
        if (status === "Available") badgeColor = "success";
        else if (status === "Requested") badgeColor = "warning";
        else if (status === "Checked Out") badgeColor = "danger";

        // Card Header with Cover
        const coverImage = book.coverUrl || "https://via.placeholder.com/100x120?text=Book";

        const cardHeader = document.createElement("div");
        cardHeader.className = "card-header text-center";
        cardHeader.innerHTML = `
        <img src="${coverImage}" alt="Book Cover"
        class="img-fluid w-100"
        style="aspect-ratio: 1 / 1.414; object-fit: cover; border-radius: 2px;" />
        `;
        card.appendChild(cardHeader);


        // Card Body
        const cardBody = document.createElement("div");
        cardBody.className = "card-body p-2";

        // Title scroll wrapper
        const titleWrapper = document.createElement("div");
        titleWrapper.className = "book-title-wrapper";

        const titleSpan = document.createElement("h5");
        titleSpan.className = "book-title";
        titleSpan.textContent = book.title || "Untitled";
        titleWrapper.appendChild(titleSpan);
        cardBody.appendChild(titleWrapper);

        // Author scroll wrapper
        const authorWrapper = document.createElement("div");
        authorWrapper.className = "book-title-wrapper";

        const authorSpan = document.createElement("h6");
        authorSpan.className = "book-title text-muted";
        authorSpan.textContent = book.author || "Unknown";
        authorWrapper.appendChild(authorSpan);
        cardBody.appendChild(authorWrapper);

        // Status badge
        const badge = document.createElement("span");
        badge.className = `badge w-100 bg-${badgeColor}`;
        badge.textContent = status;
        cardBody.appendChild(badge);

        // Button
        const button = document.createElement("button");
        button.className = `btn w-100 btn-sm mt-2 ${buttonClass}`;
        button.textContent = buttonText;
        if (buttonDisabled) button.disabled = true;

        button.onclick = () => {
         if (isUserRequest) {
          cancelBookRequest(book.id);
         } else {
          requestBook(book.id);
         }
        };

        cardBody.appendChild(button);
        card.appendChild(cardBody);
        booksCardContainer.appendChild(card);
        hideLoader();

        // Start scroll animation for both title and author if overflow
        setTimeout(() => {
         if (titleSpan.scrollWidth > titleWrapper.clientWidth) {
          titleSpan.style.animationPlayState = 'running';
         }
         if (authorSpan.scrollWidth > authorWrapper.clientWidth) {
          authorSpan.style.animationPlayState = 'running';
         }
        },
         50);

        const btn = card.querySelector("button");
        if (!btn.disabled) {
         btn.onclick = () => {
          if (isUserRequest) {
           cancelBookRequest(bookId);
          } else {
           requestBook(bookId);
          }
         };
        }

        booksCardContainer.appendChild(card);
       });
      });
    }
   );

   // Book History Table
   onSnapshot(
    query(collection(db,
     "bookRequests"), where("userId",
     "==",
     uid)),
    (snapshot) => {
     const historyTableBody = document.querySelector("#userHistoryTable tbody");
     historyTableBody.innerHTML = "";
     const sortedDocs = snapshot.docs
     .map(docSnap => {
      const data = docSnap.data();
      return {
       ...data,
       requestedAt: data.requestedAt ? new Date(data.requestedAt): new Date(0),
      };
     })
     .sort((a,
      b) => b.requestedAt - a.requestedAt);

     sortedDocs.forEach(req => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${req.title}</td>
      <td>${req.status}</td>
      <td>${req.requestedAt.toLocaleString()}</td>
      `;
      historyTableBody.appendChild(tr);
     });
    }
   );
  }

  // --- Cancel book request

  async function cancelBookRequest(bookId) {
   showLoader();
   try {
    const user = auth.currentUser;
    if (!user) return showToast("You must be logged in!", "bg-warning");
    hideLoader();

    // Find the request doc ID
    const reqSnap = await getDocs(query(
     collection(db, "bookRequests"),
     where("userId", "==", user.uid),
     where("bookId", "==", bookId),
     where("status", "==", "Pending")
    ));

    if (reqSnap.empty) {
     return showToast("No pending request found to cancel.", "bg-warning");
     hideLoader();
    }

    // Delete request and update book availability
    const requestDoc = reqSnap.docs[0];
    await deleteDoc(requestDoc.ref);

    const bookRef = doc(db, "books", bookId);
    await updateDoc(bookRef, {
     availability: "Available"
    });

    showToast("Request cancelled successfully.", "bg-success");
    hideLoader();
   } catch (err) {
    console.error("Error cancelling request:", err);
    showToast("Failed to cancel request: " + err.message, "bg-danger");
    hideLoader();
   }
  }


  // Request book
  async function requestBook(bookId) {
   showLoader();
   try {
    const user = auth.currentUser;
    if (!user) return showToast("You must be logged in!", "bg-warning");
    hideLoader();
    // Check current active requests (Pending or Approved)
    const activeRequestsSnap = await getDocs(query(
     collection(db, "bookRequests"),
     where("userId", "==", user.uid),
     where("status", "in", ["Pending", "Checked Out"])
    ));
    if (activeRequestsSnap.size >= 3) {
     return showToast("You can only have up to 3 active book requests.", "bg-warning");
     hideLoader();
    }

    // Get book details
    const bookRef = doc(db, "books", bookId);
    const bookSnap = await getDoc(bookRef);
    if (!bookSnap.exists()) return showToast("Book not found!", "bg-danger");
    hideLoader();
    const book = bookSnap.data();

    // Check for duplicate request
    const existing = await getDocs(query(
     collection(db, "bookRequests"),
     where("userId", "==", user.uid),
     where("bookId", "==", bookId),
     where("status", "in", ["Pending", "Checked Out"])
    ));
    if (!existing.empty) {
     return showToast("You've already requested or checked out this book.", "bg-warning");
     hideLoader();
    }

    // Save new request
    await addDoc(collection(db, "bookRequests"), {
     userId: user.uid,
     bookId: bookId,
     title: book.title,
     author: book.author,
     status: "Pending",
     requestedAt: new Date().toISOString()
    });

    // Update book availability to "Requested"
    await updateDoc(bookRef, {
     availability: "Requested"
    });

    showToast("Book request sent for approval.", "bg-success");
    hideLoader();
   } catch (err) {
    showToast("Error requesting book: " + err.message, "bg-danger");
    hideLoader();
   }
  }

  // --- Show Admin Dashboard ---

  function showAdminDashboard() {
   userSection.classList.add("d-none");
   adminSection.classList.remove("d-none");
   document.getElementById("main-action-btn").classList.add("d-none");
   signupModal.hide();
   loginModal.hide();
   adminLoginModal.hide();
   loadSignupRequests();
   loadAllBooks();
   loadAllUsers();
   loadBookRequests();
   loadCheckedOutBooks();
   loadAllBookRequests();
   loadRejectedBookRequests();
  }

  // --- Load Signup Requests ---

  function loadSignupRequests() {
   const psr = document.getElementById("psr");

   onSnapshot(collection(db, "signupRequests"), (snapshot) => {
    signupRequestsTableBody.innerHTML = "";

    if (snapshot.empty) {
 psr.classList.add("d-none");
 adjustColumns();
 return;
}

psr.classList.remove("d-none");
adjustColumns();


    snapshot.forEach((docSnap) => {
     const data = docSnap.data();
     const tr = document.createElement("tr");
     tr.innerHTML = `
     <td>${data.fullname}</td>
     <td>${data.email}</td>
     <td>${data.dob}</td>
     <td>${data.bloodGroup}</td>
     <td>
     <button class="btn btn-sm btn-success me-2">Approve</button>
     <button class="btn btn-sm btn-danger">Reject</button>
     </td>
     `;
     // Approve button
     tr.querySelector(".btn-success").onclick = async () => {
      showLoader();
      try {
       await approveSignup(docSnap.id, data);
       showToast(`Signup approved for ${data.fullname}`, "bg-success");
       hideLoader();
      } catch (err) {
       showToast(`Error approving: ${err.message}`, "bg-danger");
       hideLoader();
      }
     };
     // Reject button
     tr.querySelector(".btn-danger").onclick = async () => {
      showLoader();
      try {
       await deleteDoc(doc(db, "signupRequests", docSnap.id));
       showToast(`Signup request rejected for ${data.fullname}`, "bg-danger");
       hideLoader();
      } catch (err) {
       showToast(`Error rejecting: ${err.message}`, "bg-danger");
       hideLoader();
      }
     };
     signupRequestsTableBody.appendChild(tr);
    });
   });
  }

  // --- Load Book Requests ---

  function loadBookRequests() {
   const pbr = document.getElementById("pbr");

   onSnapshot(
    query(collection(db, "bookRequests"), where("status", "==", "Pending")),
    async (snapshot) => {
     const tbody = document.querySelector("#bookRequestsTable tbody");
     tbody.innerHTML = "";

     if (snapshot.empty) {
 pbr.classList.add("d-none");
 adjustColumns();
 return;
}

pbr.classList.remove("d-none");
adjustColumns();


     for (const docSnap of snapshot.docs) {
      const request = docSnap.data();
      const requestId = docSnap.id;

      const userSnap = await getDoc(doc(db, "users", request.userId));
      const userName = userSnap.exists() ? userSnap.data().fullname: "Unknown User";

      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${userName}</td>
      <td>${request.title}</td>
      <td>${request.author}</td>
      <td>${request.status}</td>
      <td>
      <button class="btn btn-sm btn-success me-2">Approve</button>
      <button class="btn btn-sm btn-danger">Reject</button>
      </td>
      `;

      // --- Approve Button ---
      tr.querySelector(".btn-success").onclick = async () => {
       showLoader(); // show loader immediately
       await new Promise((resolve) => setTimeout(resolve, 800)); // wait 1 sec

       try {
        await updateDoc(doc(db, "books", request.bookId), {
         availability: "Checked Out"
        });

        await updateDoc(doc(db, "bookRequests", requestId), {
         status: "Checked Out"
        });

        showToast("Book approved and marked as Checked Out.", "bg-success");
       } catch (err) {
        showToast("Error approving request: " + err.message, "bg-danger");
       } finally {
        hideLoader(); // always hide loader
       }
      };

      // --- Reject Button ---
      tr.querySelector(".btn-danger").onclick = async () => {
       showLoader();
       await new Promise((resolve) => setTimeout(resolve, 800)); // wait 1 sec

       try {
        await updateDoc(doc(db, "bookRequests", requestId), {
         status: "Rejected",
         rejectedAt: new Date().toISOString()
        });

        await updateDoc(doc(db, "books", request.bookId), {
         availability: "Available"
        });

        showToast("Request rejected.", "bg-success");
       } catch (err) {
        showToast("Error rejecting request: " + err.message, "bg-danger");
       } finally {
        hideLoader();
       }
      };
      tbody.appendChild(tr);
     }
    }
   );
  }


  function loadCheckedOutBooks() {
   onSnapshot(query(collection(db, "bookRequests"), where("status", "==", "Checked Out")),
    async (snapshot) => {
     const tbody = document.querySelector("#checkedOutBooksTable tbody");
     tbody.innerHTML = "";
     for (const docSnap of snapshot.docs) {
      const record = docSnap.data();
      const requestId = docSnap.id;
      // Get user's name
      const userSnap = await getDoc(doc(db, "users", record.userId));
      const userName = userSnap.exists() ? userSnap.data().fullname: "Unknown User";
      const tr = document.createElement("tr");
      tr.innerHTML = `

      <td>${userName}</td>
      <td>${record.title}</td>
      <td>${record.author}</td>
      <td>${new Date(record.requestedAt).toLocaleString()}</td>
      <td>
      <button class="btn btn-sm btn-warning">Return</button>
      </td>
      `;
      // Handle return action
      tr.querySelector("button").onclick = async () => {
       showLoader();
       try {
        const bookRef = doc(db, "books", record.bookId);
        const requestRef = doc(db, "bookRequests", requestId);

        //--- Step 1: Mark the book as Available
        await updateDoc(bookRef, {
         availability: "Available"
        });

        //--- Step 2: Mark the request as Returned
        await updateDoc(requestRef, {
         status: "Returned"
        });

        showToast("Book marked as returned.", "bg-success");
        hideLoader();

       } catch (err) {
        console.error("Error updating documents:", err);
        showToast("Error returning book: " + err.message, "bg-danger");
        hideLoader();
       }
      };

      tbody.appendChild(tr);
     }
    });
  }
  
  // --- Approve Signup ---
  
  async function approveSignup(docId, data) {
  showLoader(); // Show loader at the beginning

  try {
    // Initialize a secondary Firebase app instance
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    // Create user with secondary app (avoids logging out the admin)
    const userCredential = await createUserWithEmailAndPassword(
      secondaryAuth,
      data.email,
      data.password
    );
    const uid = userCredential.user.uid;

    // Store user data in Firestore
    await setDoc(doc(db, "users", uid), {
      fullname: data.fullname,
      email: data.email,
      dob: data.dob,
      bloodGroup: data.bloodGroup,
      joinedAt: new Date().toISOString(),
      role: "user",
    });

    // Delete from signupRequests collection
    await deleteDoc(doc(db, "signupRequests", docId));

    // Clean up the secondary app to avoid memory leaks
    await secondaryApp.delete();

    showToast("Signup approved and user created without logging out admin.", "bg-success");
  } catch (error) {
    showToast("Error approving signup: " + error.message, "bg-danger");
  } finally {
    hideLoader(); // Always hide loader when operation is done or errors out
  }
}

  
  
  // --- Add New Book ---
addBookForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("bookTitle").value.trim();
  const author = document.getElementById("bookAuthor").value.trim();
  const availability = document.getElementById("bookAvailability").value;
  const coverUrl = document.getElementById("bookCoverUrl").value.trim();
  const sponsor = document.getElementById("bookSponsor").value.trim();

  // Determine initial checkout status based on availability
  const checkoutStatus = availability === "Checked Out" ? "Checked Out" : "Available";

  showLoader(); // Show loader at the start

  try {
    await addDoc(collection(db, "books"), {
      title,
      author,
      availability, // e.g. "Available" / "Unavailable"
      coverUrl,
      sponsor,
      createdAt: Date.now()
    });

    showToast("Book added successfully.", "bg-success");
    addBookForm.reset();
  } catch (err) {
    showToast("Failed to add book: " + err.message, "bg-danger");
  } finally {
    hideLoader(); // Always hide loader after process completes
  }
});


  // --- Load All Books (Admin) ---
  function loadAllBooks() {
   const allBooksCardContainer = document.getElementById("allBooksCardContainer");

   onSnapshot(collection(db, "books"),
    (snapshot) => {
     allBooksCardContainer.innerHTML = "";

     const books = [];
     snapshot.forEach((docSnap) => {
      books.push({
       ...docSnap.data(), id: docSnap.id
      });
     });

     books
     .sort((a, b) => (a.title || "").localeCompare(b.title || ""))
     .forEach((book) => {
      const status = book.availability || "Unavailable";
      const badgeColor = status === "Available" ? "success": (status === "Checked Out" ? "warning": "secondary");

      // Create card container
      const card = document.createElement("div");
      card.className = "card";
      card.style.minWidth = "180px";
      card.style.maxWidth = "180px";

      // Card Header with Cover
      const coverImage = book.coverUrl || "https://via.placeholder.com/100x120?text=Book";
      const cardHeader = document.createElement("div");
      cardHeader.className = "card-header text-center";
      cardHeader.innerHTML = `
      <img src="${coverImage}" alt="Book Cover"
      class="img-fluid w-100"
      style="aspect-ratio: 1 / 1.414; object-fit: cover; border-radius: 2px;" />
      `;
      card.appendChild(cardHeader);
      hideLoader();

      // Card Body
      const cardBody = document.createElement("div");
      cardBody.className = "card-body p-2";

      // Title
      const titleWrapper = document.createElement("div");
      titleWrapper.className = "book-title-wrapper overflow-hidden";
      const titleSpan = document.createElement("h6");
      titleSpan.className = "card-title book-title m-0";
      titleSpan.textContent = book.title || "Untitled";
      titleWrapper.appendChild(titleSpan);
      cardBody.appendChild(titleWrapper);

      // Author
      const authorWrapper = document.createElement("div");
      authorWrapper.className = "book-title-wrapper overflow-hidden";
      const authorSpan = document.createElement("p");
      authorSpan.className = "mb-1 text-muted book-title";
      authorSpan.textContent = book.author || "Unknown";
      authorWrapper.appendChild(authorSpan);
      cardBody.appendChild(authorWrapper);
      
      // Sponsor
      const sponsorWrapper = document.createElement("div");
      sponsorWrapper.className = "book-title-wrapper overflow-hidden";
      const sponsorSpan = document.createElement("p");
      sponsorSpan.className = "mb-1 italic text-muted book-title";
      sponsorSpan.textContent = book.sponsor ? `Spon. by: ${book.sponsor}` : "No Sponsor";
      sponsorWrapper.appendChild(sponsorSpan);
      cardBody.appendChild(sponsorWrapper);

      // Badge
      const badge = document.createElement("span");
      badge.className = `badge w-100 mb-2 bg-${badgeColor}`;
      badge.textContent = status;
      cardBody.appendChild(badge);

      // Availability Dropdown
      const availabilitySelect = document.createElement("select");
      availabilitySelect.className = "form-select form-select-sm mb-2";
      const options = ["Available", "Checked Out", "Requested"];
      let originalStatus = book.availability;

      options.forEach((opt) => {
       const option = document.createElement("option");
       option.value = opt;
       option.textContent = opt;
       if (opt === book.availability) option.selected = true;
       availabilitySelect.appendChild(option);
      });

      // Save Button
      const saveBtn = document.createElement("button");
      saveBtn.className = "btn btn-sm btn-primary w-100";
      saveBtn.textContent = "Save";
      saveBtn.style.display = "none";

      // Delete Button
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn btn-sm btn-danger w-100";
      deleteBtn.textContent = "Delete";

      // Toggle buttons when status changes
      availabilitySelect.addEventListener("change",
       () => {
        const changed = availabilitySelect.value !== originalStatus;
        saveBtn.style.display = changed ? "inline-block": "none";
        deleteBtn.style.display = changed ? "none": "inline-block";
       });

      // Save button logic
      saveBtn.onclick = () => {
      showLoader();
       updateBookAvailability(book.id,
        availabilitySelect.value);
       originalStatus = availabilitySelect.value;
       saveBtn.style.display = "none";
       deleteBtn.style.display = "inline-block";
      };

      // Delete button logic
      deleteBtn.onclick = () => {
       bookIdToDelete = book.id;
       bookTitleToDelete = book.title || "Untitled";
       deleteConfirmText.innerHTML = `Are you sure you want to delete <span class="fw-bold text-white p-1 bg-danger">"${bookTitleToDelete}"</span> ?`;
       deleteConfirmModal.show();
      };

      // Append controls to body
      cardBody.appendChild(availabilitySelect);
      cardBody.appendChild(saveBtn);
      cardBody.appendChild(deleteBtn);

      // Animate scroll if overflowing
      setTimeout(() => {
       if (titleSpan.scrollWidth > titleWrapper.clientWidth) {
        titleSpan.style.animationPlayState = 'running';
       }
       if (authorSpan.scrollWidth > authorWrapper.clientWidth) {
        authorSpan.style.animationPlayState = 'running';
       }
       if (sponsorSpan.scrollWidth > sponsorWrapper.clientWidth) {
        sponsorSpan.style.animationPlayState = 'running';
       }
      },
       50);

      card.appendChild(cardBody);
      allBooksCardContainer.appendChild(card);
     });
    });
  }

  confirmDeleteBtn.onclick = async () => {
   if (!bookIdToDelete) return;
   showLoader();

   try {
    await deleteDoc(doc(db, "books", bookIdToDelete));
    showToast(`"${bookTitleToDelete}" deleted successfully.`, "bg-success");
   } catch (err) {
    showToast("Failed to delete: " + err.message, "bg-danger");
   }

   // Reset state and hide modal
   bookIdToDelete = null;
   bookTitleToDelete = null;
   deleteConfirmModal.hide();
  };

  async function updateBookAvailability(bookId, newAvailability) {
   try {
    // 1. Update the book document
    await updateDoc(doc(db,
     "books",
     bookId), {
     availability: newAvailability
    });

    // 2. Update all relevant bookRequests based on new availability
    const q = query(
     collection(db,
      "bookRequests"),
     where("bookId",
      "==",
      bookId),
     where("status",
      "in",
      ["Pending",
       "Approved",
       "Checked Out"])
    );

    const querySnapshot = await getDocs(q);

    for (const docSnap of querySnapshot.docs) {
     let newStatus = null;

     if (newAvailability === "Available") {
      newStatus = "Returned";
     } else if (newAvailability === "Checked Out") {
      newStatus = "Checked Out";
     } else if (newAvailability === "Requested") {
      newStatus = "Pending";
     }

     if (newStatus) {
      await updateDoc(doc(db, "bookRequests", docSnap.id), {
       status: newStatus
      });
     }
    }

    showToast("Book availability and request status updated.");
   } catch (err) {
    showToast("Failed to update: " + err.message);
   }
  }


  // --- Load All Users (Admin) ---
  function loadAllUsers() {
   onSnapshot(collection(db, "users"), (snapshot) => {
    allUsersTableBody.innerHTML = "";
    snapshot.forEach((docSnap) => {
     const user = docSnap.data();
     const tr = document.createElement("tr");
     tr.innerHTML = `


     <td>${user.fullname}</td>
     <td>${user.email}</td>
     <td>${user.dob}</td>
     <td>${user.bloodGroup}</td>
     <td>${new Date(user.joinedAt).toLocaleString()}</td>
     `;
     allUsersTableBody.appendChild(tr);
    });
   });
  }

  // --- Load All Book Request History (Admin) ---

  function loadAllBookRequests() {
   const tbody = document.querySelector("#allBookRequestsTable tbody");

   onSnapshot(collection(db, "bookRequests"), async (snapshot) => {
    tbody.innerHTML = "";

    // Convert docs to array and sort manually
    const sortedDocs = snapshot.docs
    .map(docSnap => {
     const data = docSnap.data();
     return {
      ...data,
      id: docSnap.id,
      requestedAt: new Date(data.requestedAt || 0), // fallback to epoch if missing
     };
    })
    .sort((a, b) => b.requestedAt - a.requestedAt); // newest first

    for (const request of sortedDocs) {
     // Get user name
     let userName = "Unknown";
     try {
      const userSnap = await getDoc(doc(db, "users", request.userId));
      if (userSnap.exists()) {
       userName = userSnap.data().fullname || "Unnamed";
      }
     } catch (err) {
      console.error("Error fetching user info", err);
     }

     const tr = document.createElement("tr");
     tr.innerHTML = `
     <td>${userName}</td>
     <td>${request.title || "Untitled"}</td>
     <td>${request.status}</td>
     <td>${request.requestedAt.toLocaleString()}</td>
     `;
     tbody.appendChild(tr);
    }
   });
  }

  // --- Load All Rejected Book Request History (Admin) ---

  function loadRejectedBookRequests() {
   const tbody = document.querySelector("#rejectedRequestsTable tbody");

   // Listen to all "Rejected" bookRequests
   onSnapshot(
    query(collection(db, "bookRequests"), where("status", "==", "Rejected")),
    async (snapshot) => {
     tbody.innerHTML = "";

     const requests = snapshot.docs
     .map((docSnap) => {
      const data = docSnap.data();
      return {
       ...data,
       id: docSnap.id,
       rejectedAt: new Date(data.rejectedAt || 0),
      };
     })
     .sort((a, b) => b.rejectedAt - a.rejectedAt); // newest first

     for (const req of requests) {
      // --- Fetch User Name ---
      let userName = "Unknown";
      try {
       const userSnap = await getDoc(doc(db, "users", req.userId));
       if (userSnap.exists()) {
        userName = userSnap.data().fullname || "Unnamed";
       }
      } catch (err) {
       console.error("Error fetching user info:", err);
      }

      // --- Create table row with placeholder first ---
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${userName}</td>
      <td>${req.title || "Untitled"}</td>
      <td><span class="book-status">Loading...</span></td>
      <td>${req.rejectedAt.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);

      // --- Real-time listener for book availability ---
      const bookRef = doc(db, "books", req.bookId);
      onSnapshot(bookRef, (bookSnap) => {
       const statusCell = tr.querySelector(".book-status");
       if (bookSnap.exists()) {
        const availability = bookSnap.data().availability || "Unavailable";
        statusCell.textContent = availability;
       } else {
        statusCell.textContent = "Deleted";
       }
      });
     }
    }
   );
  }

  // --- Generic Table Filter Utility ---
  function filterTable(tableId, searchValue, columnsToCheck = [0]) {
   const filter = searchValue.toLowerCase();
   const table = document.getElementById(tableId);
   const rows = table?.getElementsByTagName("tr") || [];

   for (let i = 1; i < rows.length; i++) {
    // skip header row
    const cells = rows[i].getElementsByTagName("td");
    const matchFound = columnsToCheck.some(colIdx =>
     cells[colIdx]?.textContent.toLowerCase().includes(filter)
    );
    rows[i].style.display = matchFound ? "": "none";
   }
  }

  // --- Search Filters ---

  // Admin dashboard: Active Checked Out Books
  document.getElementById("searchCheckedOutBooks")?.addEventListener("input", function () {
   filterTable("checkedOutBooksTable", this.value, [0, 1]); // user name, book title
  });

  // Admin dashboard: All Users
  document.getElementById("searchAllUsers")?.addEventListener("input", function () {
   filterTable("allUsersTable", this.value, [0, 1, 2, 3]); // full name, email, DOB, blood group
  });

  // Admin dashboard: All Book Requests
  document.getElementById("searchAllBookRequests")?.addEventListener("input", function () {
   filterTable("allBookRequestsTable", this.value, [0, 1]); // user name, book title
  });

  // User dashboard: Book Request History
  document.getElementById("searchUserHistory")?.addEventListener("input", function () {
   filterTable("userHistoryTable", this.value, [0]); // book title only
  });


  // Filter card elements by text for available books
  
  function filterCards(containerId, searchText) {
   const container = document.getElementById(containerId);
   const cards = container.querySelectorAll(".card");
   const query = searchText.toLowerCase();

   cards.forEach(card => {
    const title = card.querySelector("h5")?.textContent.toLowerCase() || "";
    const author = card.querySelector("h6")?.textContent.toLowerCase() || "";
    const matches = title.includes(query) || author.includes(query);
    card.style.display = matches ? "": "none";
   });
  }


  // User dashboard: Available Books (cards)
  document.getElementById("userBookSearch")?.addEventListener("input", function () {
   filterCards("booksCardContainer", this.value);
  });

  // Admin dashboard: All Books (cards)
  document.getElementById("adminBookSearch")?.addEventListener("input", function () {
   filterCards("allBooksCardContainer", this.value);
  });


  //--- Toast Notification ---


  function showToast(message, bgColor = "bg-primary") {
   const container = document.getElementById("toastContainer");

   const toastEl = document.createElement("div");
   toastEl.className = `toast slide-in m-2 align-items-center text-white ${bgColor} border-0`;
   toastEl.setAttribute("role", "alert");
   toastEl.setAttribute("aria-live", "assertive");
   toastEl.setAttribute("aria-atomic", "true");

   toastEl.innerHTML = `
   <div class="d-flex">
   <div class="toast-body">${message}</div>
   <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
   </div>
   `;

   container.appendChild(toastEl);

   const closeBtn = toastEl.querySelector(".btn-close");

   const toast = new bootstrap.Toast(toastEl, {
    autohide: false // we'll handle dismissal
   });

   toast.show();

   // Auto-dismiss after 3s with animation
   const dismiss = () => {
    if (!toastEl.classList.contains("slide-out")) {
     toastEl.classList.remove("slide-in");
     toastEl.classList.add("slide-out");
     setTimeout(() => toastEl.remove(), 400); // match duration
    }
   };

   closeBtn.addEventListener("click", dismiss);
   setTimeout(dismiss, 3000);
  }
  
  // --- Global Loader ---
function showLoader() {
  document.getElementById("loadingBackdrop").classList.remove("d-none");
}

function hideLoader() {
  setTimeout(() => {
    document.getElementById("loadingBackdrop").classList.add("d-none");
  }, 1000); // 2-second delay
}

  
  //--- PSR & PBR Column Adjust ---
  
  function adjustColumns() {
 const psr = document.getElementById("psr");
 const pbr = document.getElementById("pbr");

 const psrVisible = !psr.classList.contains("d-none");
 const pbrVisible = !pbr.classList.contains("d-none");

 if (psrVisible && pbrVisible) {
  psr.classList.remove("col-12");
  pbr.classList.remove("col-12");
  psr.classList.add("col-lg-6");
  pbr.classList.add("col-lg-6");
 } else {
  if (psrVisible) {
   psr.classList.add("col-12");
   psr.classList.remove("col-lg-6");
  }
  if (pbrVisible) {
   pbr.classList.add("col-12");
   pbr.classList.remove("col-lg-6");
  }
 }
}



 </script>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
 </script>

</body>
</html>
