<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoSync - Watch Together</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<style type="text/css" media="all">
 body {
  transition: background-color 0.3s, color 0.3s;
}

.light-mode {
  background-color: #f8f9fa;
  color: #212529;
}

.dark-mode {
  background-color: #212529;
  color: #f8f9fa;
}

.dark-mode .card {
  background-color: #2c3034;
  border-color: #373b3e;
}

.dark-mode .card-header {
  background-color: #343a40;
  border-bottom-color: #373b3e;
}

.dark-mode .form-control {
  background-color: #343a40;
  border-color: #495057;
  color: #f8f9fa;
}

#videoPlayer {
  max-height: 60vh;
  background-color: #000;
}

#connectionStatus {
  font-weight: bold;
}

/* Non-host controls styling */
.non-host #videoPlayer::-webkit-media-controls {
  opacity: 0.5;
  pointer-events: none;
}

.non-host #videoContainer::after {
  content: "Only host can control playback";
  position: absolute;
  bottom: 20px;
  left: 0;
  right: 0;
  text-align: center;
  color: white;
  background-color: rgba(0, 0, 0, 0.7);
  padding: 5px;
  font-size: 12px;
  z-index: 10;
}

.non-host #videoContainer {
  position: relative;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .col-md-6 {
    margin-bottom: 20px;
  }
  
  #videoPlayer {
    max-height: 40vh;
  }
}
</style>
<body class="light-mode">
  <div class="container mt-4">
    <div class="row">
      <div class="col-12 text-center mb-4">
        <h1>VideoSync</h1>
        <div class="form-check form-switch d-flex justify-content-center">
          <input class="form-check-input" type="checkbox" id="darkModeToggle">
          <label class="form-check-label ms-2" for="darkModeToggle">Dark Mode</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Create or Join Room</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <button id="createRoomBtn" class="btn btn-primary w-100">Create New Room</button>
            </div>
            <div class="mb-3">
              <input type="text" id="roomIdInput" class="form-control" placeholder="Enter 4-digit Room ID" maxlength="4">
            </div>
            <button id="joinRoomBtn" class="btn btn-success w-100">Join Room</button>
          </div>
        </div>

        <div id="roomInfo" class="card mb-4 d-none">
          <div class="card-header">
            <h5 class="mb-0">Room Information</h5>
          </div>
          <div class="card-body">
            <p>Room ID: <span id="displayRoomId"></span></p>
            <p>Connected devices: <span id="userCount">1</span></p>
            <p id="connectionStatus" class="text-success">Connected to server</p>
            <p id="roleIndicator"></p>
          </div>
        </div>

        <div id="hostControls" class="card mb-4 d-none">
          <div class="card-header">
            <h5 class="mb-0">Host Controls</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <input type="file" id="videoFileInput" class="form-control" accept="video/*">
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Video Player</h5>
          </div>
          <div class="card-body" id="videoContainer">
            <video id="videoPlayer" class="w-100" controls></video>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
  // DOM elements
  const darkModeToggle = document.getElementById('darkModeToggle');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomIdInput = document.getElementById('roomIdInput');
  const roomInfo = document.getElementById('roomInfo');
  const displayRoomId = document.getElementById('displayRoomId');
  const userCount = document.getElementById('userCount');
  const connectionStatus = document.getElementById('connectionStatus');
  const roleIndicator = document.getElementById('roleIndicator');
  const hostControls = document.getElementById('hostControls');
  const videoFileInput = document.getElementById('videoFileInput');
  const videoPlayer = document.getElementById('videoPlayer');
  const videoContainer = document.getElementById('videoContainer');

  // App state
  let socket;
  let currentRoomId = null;
  let isHost = false;
  let backendUrl = 'https://stream-c6pt.onrender.com'; // Replace with your Render URL
  let lastPlaybackState = { isPlaying: false, currentTime: 0 };

  // Initialize dark mode toggle
  darkModeToggle.addEventListener('change', function() {
    document.body.classList.toggle('dark-mode', this.checked);
    document.body.classList.toggle('light-mode', !this.checked);
    localStorage.setItem('darkMode', this.checked);
  });

  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    darkModeToggle.checked = true;
    document.body.classList.add('dark-mode');
    document.body.classList.remove('light-mode');
  }

  // Create room
  createRoomBtn.addEventListener('click', function() {
    fetch(`${backendUrl}/api/room`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      joinRoom(data.roomId, true);
    })
    .catch(error => {
      console.error('Error creating room:', error);
      alert('Failed to create room. Please try again.');
    });
  });

  // Join room
  joinRoomBtn.addEventListener('click', function() {
    const roomId = roomIdInput.value.trim();
    if (roomId.length !== 4 || !/^\d+$/.test(roomId)) {
      alert('Please enter a valid 4-digit room ID');
      return;
    }
    
    fetch(`${backendUrl}/api/room/${roomId}`)
      .then(response => response.json())
      .then(data => {
        if (data.exists) {
          joinRoom(roomId, false);
        } else {
          alert('Room does not exist');
        }
      })
      .catch(error => {
        console.error('Error checking room:', error);
        alert('Failed to check room. Please try again.');
      });
  });

  // Join room function
  function joinRoom(roomId, host) {
    currentRoomId = roomId;
    isHost = host;
    
    // Initialize socket connection
    socket = io(backendUrl);
    
    // Socket event handlers
    socket.on('connect', () => {
      socket.emit('join-room', roomId);
    });
    
    socket.on('connection-status', (status) => {
      connectionStatus.textContent = status;
    });
    
    socket.on('user-count', (count) => {
      userCount.textContent = count;
    });
    
    socket.on('play', () => {
      if (!isHost) {
        videoPlayer.play().catch(e => console.log('Auto-play prevented:', e));
      }
    });
    
    socket.on('pause', () => {
      if (!isHost) {
        videoPlayer.pause();
      }
    });
    
    socket.on('seek', (time) => {
      if (!isHost && !isNaN(time)) {
        // Only seek if the difference is significant to prevent flickering
        if (Math.abs(videoPlayer.currentTime - time) > 0.5) {
          videoPlayer.currentTime = time;
        }
      }
    });
    
    socket.on('playback-state', (state) => {
      lastPlaybackState = state;
      if (!isHost) {
        // Only update if significantly different to prevent UI flickering
        if (Math.abs(videoPlayer.currentTime - state.currentTime) > 0.5) {
          videoPlayer.currentTime = state.currentTime;
        }
        if (state.isPlaying && videoPlayer.paused) {
          videoPlayer.play().catch(e => console.log('Play prevented:', e));
        } else if (!state.isPlaying && !videoPlayer.paused) {
          videoPlayer.pause();
        }
      }
    });
    
    socket.on('room-error', (message) => {
      alert(message);
    });
    
    // Update UI
    displayRoomId.textContent = roomId;
    roomInfo.classList.remove('d-none');
    roleIndicator.textContent = isHost ? 'Your role: Host' : 'Your role: Viewer';
    
    if (isHost) {
      hostControls.classList.remove('d-none');
      videoContainer.classList.remove('non-host');
    } else {
      hostControls.classList.add('d-none');
      videoContainer.classList.add('non-host');
    }
    
    // Disable join/create buttons
    createRoomBtn.disabled = true;
    joinRoomBtn.disabled = true;
    roomIdInput.disabled = true;
  }

  // Host controls - file upload
  videoFileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      const file = this.files[0];
      const formData = new FormData();
      formData.append('video', file);
      
      fetch(`${backendUrl}/api/upload/${currentRoomId}`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          videoPlayer.src = `${backendUrl}/api/stream/${currentRoomId}?t=${Date.now()}`;
          videoPlayer.load();
          // Initialize playback state
          lastPlaybackState = { isPlaying: false, currentTime: 0 };
        }
      })
      .catch(error => {
        console.error('Error uploading video:', error);
        alert('Failed to upload video. Please try again.');
      });
    }
  });

  // Video player event handlers
  videoPlayer.addEventListener('play', function() {
    if (isHost && currentRoomId) {
      socket.emit('play');
      lastPlaybackState.isPlaying = true;
    } else if (!isHost) {
      // Sync with host's state
      if (!lastPlaybackState.isPlaying) {
        videoPlayer.pause();
      }
    }
  });

  videoPlayer.addEventListener('pause', function() {
    if (isHost && currentRoomId) {
      socket.emit('pause');
      lastPlaybackState.isPlaying = false;
    } else if (!isHost) {
      // Sync with host's state
      if (lastPlaybackState.isPlaying) {
        videoPlayer.play().catch(e => console.log('Play prevented:', e));
      }
    }
  });

  videoPlayer.addEventListener('seeked', function() {
    if (isHost && currentRoomId) {
      socket.emit('seek', videoPlayer.currentTime);
      lastPlaybackState.currentTime = videoPlayer.currentTime;
    }
  });

  // Periodically sync playback state (helps with drift correction)
  setInterval(() => {
    if (isHost && currentRoomId && !isNaN(videoPlayer.duration)) {
      socket.emit('playback-state', {
        isPlaying: !videoPlayer.paused,
        currentTime: videoPlayer.currentTime
      });
    }
  }, 3000);

  // Disable right-click menu on video player
  videoPlayer.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });

  // Disable keyboard shortcuts for non-hosts
  document.addEventListener('keydown', function(e) {
    if (!isHost && (e.target === videoPlayer || e.target === document.body)) {
      // Space (32), K (75), L (76), J (74), Arrow keys (37-40)
      if ([32, 75, 76, 74, 37, 38, 39, 40].includes(e.keyCode)) {
        e.preventDefault();
      }
    }
  });

  // For mobile devices, prevent touch events from affecting playback
  if ('ontouchstart' in window) {
    videoPlayer.addEventListener('touchstart', function(e) {
      if (!isHost) {
        e.preventDefault();
      }
    }, { passive: false });

    videoPlayer.addEventListener('touchmove', function(e) {
      if (!isHost) {
        e.preventDefault();
      }
    }, { passive: false });
  }
});
  </script>
</body>
</html>